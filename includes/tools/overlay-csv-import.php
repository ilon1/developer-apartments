<?php
if (!defined('ABSPATH')) exit;
add_action('admin_menu', function(){ add_management_page('Import overlay priradení','Import overlay priradení','manage_options','devapt-overlay-csv-import','devapt_overlay_csv_screen'); });
function devapt_overlay_csv_screen(){ if(!current_user_can('manage_options')) return; echo '<div class="wrap"><h1>Import overlay priradení</h1>'; if(!empty($_POST['devapt_do_import']) && check_admin_referer('devapt_overlay_csv')){ if(!empty($_FILES['csv']['tmp_name'])){ $fh = fopen($_FILES['csv']['tmp_name'],'r'); $ok=0;$err=0; while(($row=fgetcsv($fh,0,','))!==false){ if(count($row)<3) { $err++; continue; } $term_id = intval($row[0]); $uid = sanitize_text_field($row[1]); $apt = intval($row[2]); $raw = get_term_meta($term_id,'dev_map_data',true); $arr = json_decode(is_string($raw)?$raw:'[]', true); if(!is_array($arr)) $arr=[]; $changed=false; foreach($arr as &$s){ if( isset($s['uid']) && (string)$s['uid']===$uid ){ $s['target_type']='post'; $s['target_id']=$apt; $changed=true; break; } } if($changed){ update_term_meta($term_id,'dev_map_data', wp_json_encode($arr)); update_post_meta($apt,'dev_overlay_uid',$uid); $ok++; } else { $err++; } } fclose($fh); echo '<div class="updated"><p>Hotovo. Úspešne: '.intval($ok).', neúspešne: '.intval($err).'</p></div>'; } else { echo '<div class="error"><p>CSV nebolo nahrané.</p></div>'; } } echo '<form method="post" enctype="multipart/form-data">'; wp_nonce_field('devapt_overlay_csv'); echo '<p>CSV formát: <code>floor_term_id, polygon_uid, apartment_id</code></p>'; echo '<p><input type="file" name="csv" accept=".csv" required> <button type="submit" name="devapt_do_import" class="button button-primary">Importovať</button></p>'; echo '</form></div>'; }
