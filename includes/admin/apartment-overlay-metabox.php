<?php
if (!defined('ABSPATH')) exit;
add_action('add_meta_boxes', function(){ add_meta_box('dev_apt_overlay', __('Priradiť k overlayu poschodia','developer-apartments'), 'dev_apt_overlay_metabox_cb', 'apartment', 'side', 'default'); });
function dev_apt_overlay_metabox_cb($post){ $uid = get_post_meta($post->ID,'dev_overlay_uid', true); wp_nonce_field('dev_apt_overlay_meta','dev_apt_overlay_meta_nonce'); echo '<p class="description">Vyberte poschodie a overlay polygon (UID). Uloženie prepojí byt s polygon-om.</p>'; $floors = get_terms(['taxonomy'=>'project_structure','hide_empty'=>false,'fields'=>'id=>name']); echo '<p><label>Poschodie</label><br />'; echo '<select id="dev_apt_floor_sel" class="widefat">'; echo '<option value="">— vyberte —</option>'; if(!is_wp_error($floors)){ foreach($floors as $id=>$name){ echo '<option value="'.esc_attr($id).'">'.esc_html($name).'</option>'; } } echo '</select></p>'; echo '<p><label>Overlay (UID)</label><br />'; echo '<select id="dev_apt_overlay_uid" class="widefat"><option value="">— vyberte —</option></select></p>'; echo '<p><label>Aktuálne priradenie (UID)</label><br /><input type="text" class="widefat" value="'.esc_attr($uid).'" readonly></p>'; echo '<p><button type="button" class="button" id="dev_apt_assign_btn">Priradiť byt k overlayu</button></p>'; ?>
  <script>(function($){ function fillShapes(term){ $('#dev_apt_overlay_uid').html('<option value="">Načítavam…</option>'); $.getJSON(ajaxurl, {action:'devapt_get_floor_shapes', term_id: term}).done(function(resp){ var $s=$('#dev_apt_overlay_uid'); $s.empty().append('<option value="">— vyberte —</option>'); if(resp&&resp.success){ (resp.data.items||[]).forEach(function(it){ $s.append($('<option>').val(it.uid).text(it.label)); } ) } }); } $('#dev_apt_floor_sel').on('change', function(){ var t=$(this).val(); if(t){ fillShapes(t); } else { $('#dev_apt_overlay_uid').empty().append('<option value="">— vyberte —</option>'); } }); $('#dev_apt_assign_btn').on('click', function(e){ e.preventDefault(); var postId=<?php echo intval($post->ID); ?>; var t=$('#dev_apt_floor_sel').val(); var u=$('#dev_apt_overlay_uid').val(); if(!t||!u){ alert('Vyberte poschodie aj overlay UID.'); return; } $.post(ajaxurl, {action:'devapt_assign_overlay_to_apartment', term_id:t, uid:u, apartment_id:postId, _ajax_nonce:'<?php echo wp_create_nonce('devapt_overlay_assign');?>'}).done(function(resp){ if(resp&&resp.success){ alert('Priradené.'); location.reload(); } else { alert('Chyba priradenia.'); } }).fail(function(){ alert('AJAX zlyhal.'); }); }); })(jQuery);</script>
<?php }
add_action('wp_ajax_devapt_get_floor_shapes', function(){ if ( ! current_user_can('manage_options') ) wp_send_json_error(['msg'=>'forbidden'], 403); $term = isset($_GET['term_id']) ? intval($_GET['term_id']) : 0; if(!$term) wp_send_json_error(['msg'=>'missing term'],400); $raw = get_term_meta($term,'dev_map_data',true); $arr = json_decode(is_string($raw)?$raw:'[]', true); if(!is_array($arr)) $arr=[]; $items=[]; foreach($arr as $s){ $uid = isset($s['uid'])? (string)$s['uid'] : ''; if(!$uid) continue; $title = !empty($s['custom_title'])? $s['custom_title'] : ( !empty($s['target_type'])? ($s['target_type'].'#'.($s['target_id']??'')) : 'polygon'); $items[]=['uid'=>$uid,'label'=>$uid.' – '.$title]; } wp_send_json_success(['items'=>$items]); });
add_action('wp_ajax_devapt_assign_overlay_to_apartment', function(){ if ( ! current_user_can('manage_options') ) wp_send_json_error(['msg'=>'forbidden'], 403); check_ajax_referer('devapt_overlay_assign'); $term = isset($_POST['term_id'])? intval($_POST['term_id']) : 0; $uid = isset($_POST['uid'])? sanitize_text_field($_POST['uid']) : ''; $apt = isset($_POST['apartment_id'])? intval($_POST['apartment_id']) : 0; if(!$term || !$uid || !$apt) wp_send_json_error(['msg'=>'missing'],400); $raw = get_term_meta($term,'dev_map_data',true); $arr = json_decode(is_string($raw)?$raw:'[]', true); if(!is_array($arr)) $arr=[]; $changed=false; foreach($arr as &$s){ if( isset($s['uid']) && (string)$s['uid']===$uid ){ $s['target_type']='post'; $s['target_id']=$apt; $changed=true; break; } } if($changed){ update_term_meta($term,'dev_map_data', wp_json_encode($arr)); update_post_meta($apt,'dev_overlay_uid',$uid); wp_send_json_success(['ok'=>1]); } wp_send_json_error(['msg'=>'uid_not_found'],404); });
